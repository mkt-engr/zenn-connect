---
title: "ç”»é¢é·ç§»æ™‚ã«ä¸è¦ãªAPIé€šä¿¡ã‚’ä¸­æ­¢ã—ã¦ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã‚’å‘ä¸Šã•ã›ã‚‹"
emoji: "ğŸ‘º"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["React", "TypeScript", "JavaScript", "Axios"]
published: true
---

# æ¦‚è¦

:::message
ã“ã®è¨˜äº‹ã¯ PC ã§è¦‹ãŸæ–¹ãŒã‚ˆã„ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚2 ç¨®é¡ã®ã‚½ãƒ¼ã‚¹ã®å‹•ä½œã®é•ã„ã‚’ã‚ã‹ã‚Šã‚„ã™ãã™ã‚‹ãŸã‚ã«ãƒ–ãƒ©ã‚¦ã‚¶ã®æ©Ÿèƒ½ã‚’ä½¿ã£ã¦é€šä¿¡é€Ÿåº¦ã‚’é…ãã™ã‚‹ãŸã‚ã§ã™ã€‚
:::
ã“ã‚“ã«ã¡ã¯ã€‚ã¾ã£ãã‚“ã¨ã£ã—ã‚…ã§ã™([@mkt_phys](https://twitter.com/mkt_phys))ã€‚ä»Šå›ã¯ç”»é¢é·ç§»ã—ãŸéš›ã« API é€šä¿¡ã‚’è¡Œã„ã€ç‰¹å®šã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æƒ…å ±ã‚’å–å¾—ã—ãƒ–ãƒ©ã‚¦ã‚¶ã«è¡¨ç¤ºã™ã‚‹ã‚·ãƒ¥ãƒãƒ¥ã‚¨ãƒ¼ã‚·ãƒ§ãƒ³ã‚’è€ƒãˆã¾ã™ã€‚4 ã¤ã®ãƒœã‚¿ãƒ³ãŒã‚ã‚Šãã‚Œãã‚Œã®ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ãã‚Œãã‚Œç•°ãªã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚
![](/images/abort-fetch-with-axios/example.png)

ã“ã®æ™‚ã€æœ€åˆã¯ 1 ã‚’ã‚¯ãƒªãƒƒã‚¯ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã®è¡¨ç¤ºã‚’å¾…ã£ã¦ã„ãŸæ™‚ã«ã€Œã‚„ã£ã±ã‚Šãƒ¦ãƒ¼ã‚¶ãƒ¼ 2 ã®æƒ…å ±ãŒæ¬²ã—ã„ã‹ã‚‰ 2 ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã‚ˆã†ã€ã¨æ€ã£ãŸå ´åˆã«è¡¨ç¤ºã™ã‚‹å¿…è¦ã®ãªã„ãƒ¦ãƒ¼ã‚¶ãƒ¼ 1 ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã¯ä¸è¦ã§ã™ã‚ˆã­ã€‚ã“ã®ã‚ˆã†ãªä¸è¦ãªãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’è¿”ã™é€šä¿¡ã‚’ä¸­æ­¢ã™ã‚‹æ–¹æ³•ã«ã¤ã„ã¦è¨˜äº‹ã«ã—ã¾ã—ãŸã€‚

è¨˜äº‹ã®ã‚¿ã‚¤ãƒˆãƒ«ã®ã€Œãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãŒä¸ŠãŒã‚‹ã€ã¨ã„ã†ã®ã¯ã€Œä¸è¦ãªé€šä¿¡ã‚’ä¸­æ­¢ã—ã€ä¸è¦ãªãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã‚’é¿ã‘ã‚‹ã“ã¨ãŒã§ãã‚‹ã€ã¨ã„ã†æ„å‘³ã§ä½¿ã£ã¦ã„ã¾ã™ã€‚

å¾Œã»ã©ã‚³ãƒ¼ãƒ‰ã¯ãŠè¦‹ã›ã—ã¾ã™ãŒç§ã®å¥½ããª React ã§æ›¸ã„ã¦ã„ã¾ã™ã€‚ã§ã™ãŒè€ƒãˆæ–¹è‡ªä½“ã¯ãƒ—ãƒ¬ãƒ¼ãƒ³ãª JavaScript ã‚„ Vue ã§ã‚‚ç”Ÿã‹ã›ã‚‹ã¨æ€ã„ã¾ã™ã€‚

ãªãŠã€ä¸»ã«åˆ©ç”¨ã—ãŸãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚

| ãƒ©ã‚¤ãƒ–ãƒ©ãƒª       | ãƒãƒ¼ã‚¸ãƒ§ãƒ³ |
| ---------------- | ---------- |
| React            | 17.0.0     |
| React-Router-DOM | 6.0.0      |
| Axios            | 0.27.2     |

# äº‹å‰æº–å‚™

å®Ÿéš›ã«ã‚³ãƒ¼ãƒ‰ã‚’å‹•ã‹ã™å‰ã«ä¸è¦ãªãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’æ‰“ã¡åˆ‡ã£ãŸå ´åˆã¨ãã†ã§ãªã„å ´åˆã®é•ã„ã‚’ã‚ã‹ã‚Šã‚„ã™ãã™ã‚‹ãŸã‚ã«ãƒ–ãƒ©ã‚¦ã‚¶ã®é–‹ç™ºè€…ãƒ„ãƒ¼ãƒ«ã‹ã‚‰é€šä¿¡é€Ÿåº¦ã®èª¿æ•´ã‚’ã—ã¾ã™ã€‚

ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¿ãƒ–ã‚’é–‹ã„ã¦ä»¥ä¸‹ã®ç”»åƒã®ã‚ˆã†ã« No throttling ã‚’ã‚¯ãƒªãƒƒã‚¯ã— Slow 3G ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚ã“ã†ã™ã‚‹ã“ã¨ã§é€šä¿¡é€Ÿåº¦ãŒé…ããªã‚Šã€ä¸è¦ãªãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ãŒç™ºç”Ÿã—ãªã„ã“ã¨ãŒã‚ã‹ã‚Šã‚„ã™ããªã‚Šã¾ã™ã€‚

![](/images/abort-fetch-with-axios/network1.png)
![](/images/abort-fetch-with-axios/network2.png)

# ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ä¸­æ­¢ã—ãªã„å ´åˆã¨ã™ã‚‹å ´åˆã®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã®é•ã„

å®Ÿéš›ã«å®Ÿè£…ã—ãŸã‚‚ã®ã¯ã“ã¡ã‚‰ã§ã™ã€‚

- ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’**ä¸­æ­¢ã—ãªã„**å ´åˆã®æŒ™å‹•ã‚’è¦‹ãŸã„æ™‚ï¼šNot Cancel Fetch ã‚’ã‚¯ãƒªãƒƒã‚¯
- ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’**ä¸­æ­¢ã™ã‚‹**å ´åˆã®æŒ™å‹•ã‚’è¦‹ãŸã„æ™‚ï¼šCancel Fetch Fetch ã‚’ã‚¯ãƒªãƒƒã‚¯

@[codesandbox](https://codesandbox.io/embed/apitong-xin-wozhong-duan-suru-fz68vf?fontsize=14&hidenavigation=1&theme=dark)

`/1`ã® URL ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ãŸå ´åˆã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ ID ãŒ 1 ã®ã‚‚ã®ã‚’å–å¾—ã—ãƒ–ãƒ©ã‚¦ã‚¶ã«è¡¨ç¤ºã—ã¦ã„ã¾ã™ã€‚4 ã¤ã®ãƒœã‚¿ãƒ³ãŒã‚ã‚Šã¾ã™ãŒã€ãã‚Œãã‚Œã®ãƒœã‚¿ãƒ³ã®æ•°å­—ãŒ URL å¯¾å¿œã—ã¦ã„ã¾ã™ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ ID ãŒ 3 ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æƒ…å ±ãŒæ¬²ã—ã„å ´åˆã¯ 3 ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨è¨€ã£ãŸå…·åˆã§ã™ã€‚

## é€šä¿¡ã‚’ä¸­æ­¢ã—ãªã„å ´åˆã®å®Ÿè£…

`useEffect`å†…ã§ Axios ã‚’ç”¨ã„ã¦é€šä¿¡ã‚’è¡Œã„ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’å–å¾—ã—ã¾ã™ã€‚å–å¾—ã—ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã†ã¡ IDã€ãƒ¦ãƒ¼ã‚¶ãƒ¼åã€ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚`useEffect`ã®ç¬¬ 2 å¼•æ•°ã« id ã‚’ç”¨ã„ã¦ã„ã‚‹ã®ã¯ç”»é¢é·ç§»ã‚’ã—ãŸå ´åˆã«ã®ã¿é€šä¿¡ã‚’è¡Œã„ãŸã„ã‹ã‚‰ã§ã™ã€‚

```ts:NotCancelFetch.tsx
const NotCancelFetch: FC = () => {
  //URLã®ãƒ‘ãƒ©ãƒ¡ã‚¿ã‚’å–å¾—
  const { id } = useParams();

  const [user, setUser] = useState<User | null>();
  useEffect(() => {
    //APIã®URLã¨ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ¡ã‚½ãƒƒãƒ‰
    const options: AxiosRequestConfig = {
      url: `${url}/users/${id}`, //url:JSON Placeholder
      method: "GET",
    };

    axios(options).then((res: AxiosResponse<User>) => {
      setUser(res.data);
    })
    .catch((e) => {
      console.log(e.message);
    });
    //ç”»é¢é·ç§»ã™ã‚‹åº¦(URLã®ãƒ‘ãƒ©ãƒ¡ã‚¿ã®idãŒå¤‰ã‚ã‚‹åº¦)ã«é€šä¿¡ã‚’è¡Œã†
  }, [id]);

  return (
    <div>
      // ãƒªãƒ³ã‚¯ãªã©ã¯çœç•¥
      <ul>
        <li>ID : {user?.id}</li>
        <li>ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼š{user?.name}</li>
        <li>ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ï¼š{user?.email}</li>
      </ul>
    </div>
  );
};
```

ç‰¹æ®µå¤‰ã‚ã£ãŸã¨ã“ã‚ã‚‚ãªã„ã‚ˆãã‚ã‚‹å®Ÿè£…ã ã¨æ€ã„ã¾ã™ï¼ˆAxios ã®å‹ä»˜ã‘ã«é–¢ã—ã¦ã¯ç§ãŒæ›¸ã„ãŸ[ã“ã¡ã‚‰](https://zenn.dev/mkt_engr/articles/axios-req-res-typescript)ã®è¨˜äº‹ã‚’å‚ç…§ã—ã¦ãã ã•ã„ç¬‘ï¼‰ã€‚äº‹å‰æº–å‚™ã§ãŠè©±ã—ã—ãŸé€šã‚Šé€šä¿¡é€Ÿåº¦ã‚’é…ãã—ã¦ã¿ã‚‹ã¨æ¬¡ã®ã‚ˆã†ãªæŒ™å‹•ã«ãªã‚Šã¾ã™ã€‚
![ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ä¸­æ­¢ã—ãªã„å ´åˆã®æŒ™å‹•](/images/abort-fetch-with-axios/notCancelFetch.gif)

åˆã‚ã« ID ãŒ 1 ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æƒ…å ±ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ã¨ã—ã¾ã™ã€‚ã¾ãš 2 ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ ID ãŒ 2 ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æƒ…å ±ãŒè¡¨ç¤ºã•ã‚Œã‚‹å‰ã« 3,4 ã¨ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨æœ€çµ‚çš„ã«ã¯å¿…è¦ã®ãªã„ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æƒ…å ±ï¼ˆID ãŒ 2,3ï¼‰ãŒä¸€ç¬ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã•ã‚Œã¦ç”»é¢ãŒã¡ã‚‰ã¤ã„ã¦ã„ã‚‹ã®ãŒã‚ã‹ã‚‹ã¨æ€ã„ã¾ã™ã€‚

ä»Šå›ã¯ã“ã®ãƒ ãƒ€ãªé€šä¿¡ã‚’ä¸­æ­¢ã—ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã•ã›ãªã„å®Ÿè£…ã‚’è¡Œã„ã¾ã™ã€‚

## é€šä¿¡ã‚’ä¸­æ­¢ã™ã‚‹å ´åˆã®å®Ÿè£…

ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’æ³¨è¦–ã™ã‚‹å ´åˆã«ã‚­ãƒ¢ã¨ãªã£ã¦ãã‚‹ã®ã¯`AbortController`ã§ã™ï¼ˆã¡ãªã¿ã«è‹±å˜èªã® abort ã¯ã€Œä¸­æ­¢ã™ã‚‹ã€ã‚„ã€Œä¸­æ–­ã™ã‚‹ã€ã¨ã„ã£ãŸæ„å‘³ãŒã‚ã‚Šã¾ã™ï¼‰ã€‚ã“ã®`AbortController`ã¨`Axios`ã‚’ç´ã¥ã‘ã‚‹ã“ã¨ã§ç”»é¢é·ç§»ã™ã‚‹éš›ã«é€šä¿¡ã‚’ä¸­æ–­ã§ãã¾ã™ã€‚å…·ä½“çš„ãªå®Ÿè£…ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã€é€šä¿¡ã‚’ä¸­æ­¢ã—ãªã„æ™‚ã¨æ¯”ã¹ãŸå ´åˆã®ã‚½ãƒ¼ã‚¹ã‹ã‚‰ã®å¤‰æ›´ç‚¹ã¯ 3 ç®‡æ‰€ã§ã™ã€‚

```diff ts:CancelFetch.tsx
const CancelFetch: FC = () => {
  const { id } = useParams();
  const [user, setUser] = useState<User | null>();
  useEffect(() => {
+   const controller = new AbortController();
    const options: AxiosRequestConfig = {
      url: `${url}/users/${id}`,
      method: "GET",
+     signal: controller.signal, //AbortControllerã¨Axiosã®ç´ä»˜ã‘
    };

    axios(options)
      .then((res: AxiosResponse<User>) => {
        setUser(res.data);
      })
      .catch((e) => {
        console.log(e.message);
      });
+    return () => {
+      //ç”»é¢é·ç§»ã™ã‚‹æ™‚(ã‚¢ãƒ³ãƒã‚¦ãƒ³ãƒˆã™ã‚‹æ™‚)ã«é€šä¿¡ã‚’ä¸­æ­¢ã™ã‚‹
+      controller.abort();
+    };
  }, [id]);

  return (
    <div>
      // ãƒªãƒ³ã‚¯ãªã©ã¯çœç•¥
      <ul>
        <li>ID : {user?.id}</li>
        <li>ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼š{user?.name}</li>
        <li>ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ï¼š{user?.email}</li>
      </ul>
    </div>
  );
};
```

äº‹å‰æº–å‚™ã§ãŠè©±ã—ã—ãŸé€šã‚Šé€šä¿¡é€Ÿåº¦ã‚’é…ãã—ã¦ã¿ã‚‹ã¨æ¬¡ã®ã‚ˆã†ãªæŒ™å‹•ã«ãªã‚Šã¾ã™ã€‚
![é€šä¿¡ã‚’ä¸­æ­¢ã—ãŸå ´åˆã®æŒ™å‹•](/images/abort-fetch-with-axios/cancelFetch.gif)

åˆã‚ã« ID ãŒ 1 ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã¦ãã®å¾Œ 2,3,4 ã¨ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å‹•ãã¯é€šä¿¡ã‚’ä¸­æ­¢ã—ãªã„å ´åˆã¨å¤‰ãˆã¦ã„ã¾ã›ã‚“ã€‚ã—ã‹ã— 2,3 ã®é€šä¿¡ã¯è¡Œã‚ã‚Œã¦ãŠã‚‰ãšãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã‚‚ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ä¸‹è¨˜ã®ç”»åƒã®ã‚ˆã†ã« 2,3 ã®é€šä¿¡ãŒä¸­æ­¢ã•ã‚Œã¦ã„ã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚(UX ã‚’è€ƒãˆã‚‹ã¨ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ç”»é¢ãŒå¿…è¦ã§ã™ãŒä»˜ã‘ã¦ã¾ã›ã‚“ã€‚ã™ã¿ã¾ã›ã‚“ã€‚)

![é€šä¿¡ã‚’ä¸­æ­¢ã—ãŸå ´åˆã®ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã®æ§˜å­](/images/abort-fetch-with-axios/cancelFetchNetwork.png)

æœ€å¾Œã« 3 ã¤ã®å¤‰æ›´ç‚¹ã«ã¤ã„ã¦èª¬æ˜ã—ã¾ã™ã€‚

1. AbortController ã‚’ new ã™ã‚‹
2. AbortController ã¨ Axios ã®ç´ä»˜ã‘ã‚’è¡Œã†
3. ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—æ™‚ã®å‡¦ç†ã«é€šä¿¡ã‚’ä¸­æ­¢ã™ã‚‹å‡¦ç†ã‚’è¡Œã†

1 ã¨ 2 ã¯ã‚»ãƒƒãƒˆãªã®ã§ã¾ã¨ã‚ã¦æ›¸ãã¨

```ts
const controller = new AbortController();
const options: AxiosRequestConfig = {
  url: `${url}/users/${id}`,
  method: "GET",
  signal: controller.signal,
};
```

ã¨ãªã‚Šã¾ã™ã€‚AbortController ã‚’ new ã—ã¦ Axios ã®è¨­å®šã«è¿½åŠ ã™ã‚‹ã ã‘ã§ã™ã€‚AbortController è‡ªä½“ã¯ React ã®ç‰¹æœ‰ã®ã‚‚ã®ã§ã¯ãªããƒ—ãƒ¬ãƒ¼ãƒ³ãª JavaScript ã®ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã§ã™ã€‚

æœ€å¾Œã« 3 ã®å¤‰æ›´ã§ã™ãŒç”»é¢é·ç§»æ™‚ï¼ˆã‚¢ãƒ³ãƒã‚¦ãƒ³ãƒˆæ™‚ï¼‰ã«é€šä¿¡ã‚’ä¸­æ–­ã—ãŸã„ã®ã§ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—æ™‚ã®å‡¦ç†ã‚’è¿½åŠ ã—ã¾ã™ã€‚

```ts
useEffect(() => {
  //é€šä¿¡ãªã©ã®å‡¦ç†ã¯çœç•¥

  return () => {
    controller.abort();
  };
}, [id]);
```

# ã¾ã¨ã‚

- é€šä¿¡ã‚’ä¸­æ­¢ã—ãŸã„ã¨ãã¯ AbortController ã‚’ä½¿ã†
- ç”»é¢é·ç§»ï¼ˆã‚¢ãƒ³ãƒã‚¦ãƒ³ãƒˆï¼‰ã™ã‚‹æ™‚ã«ä¸è¦ãªé€šä¿¡ã‚’ä¸­æ­¢ã™ã‚‹ã“ã¨ã§ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã®å‘ä¸Šã«ã‚‚ã¤ãªãŒã‚‹

# å‚è€ƒ

[Axios ã®å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆï¼ˆAxios Cancellationï¼‰](https://axios-http.com/docs/cancellation)
[MDNï¼ˆAbortControllerï¼‰](https://developer.mozilla.org/ja/docs/Web/API/AbortController)
[All useEffect Mistakes Every Junior React Developer Makes](https://www.youtube.com/watch?v=QQYeipc_cik)
ã¡ãªã¿ã«ã“ã® YouTube ã®å‹•ç”»ã¯ v0.22.0 ä»¥é™ã® Axios ã§ã¯éæ¨å¥¨ã® CancelToken ã‚’ä½¿ã£ãŸæ–¹æ³•ã‚‚èª¬æ˜ã—ã¦ã„ã¾ã™ã€‚
